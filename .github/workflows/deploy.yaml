name: Build and Deploy Blog
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm init -y
          # Use node-fetch v2 which supports CommonJS
          npm install gray-matter reading-time marked prismjs node-fetch@2

      - name: Create Directories
        run: mkdir -p scripts posts

      - name: Fetch Author Info
        run: |
          cat << 'EOF' > scripts/fetch-author.js
          const fetch = require('node-fetch');
          const fs = require('fs');

          async function fetchGithubProfile() {
            const username = process.env.GITHUB_REPOSITORY.split('/')[0];
            const response = await fetch(`https://api.github.com/users/${username}`);
            const data = await response.json();
            
            const author = {
              name: data.name || username,
              avatar: data.avatar_url,
              bio: data.bio,
              location: data.location,
              github: data.html_url,
              blog: data.blog,
              followers: data.followers
            };
            
            fs.writeFileSync('author.json', JSON.stringify(author, null, 2));
          }

          fetchGithubProfile().catch(console.error);
          EOF

      - name: Generate Posts Index
        run: |
          cat << 'EOF' > scripts/generate-index.js
          const fs = require('fs');
          const path = require('path');
          const matter = require('gray-matter');
          const readingTime = require('reading-time');
          const { marked } = require('marked');
          const Prism = require('prismjs');
          require('prismjs/components/prism-typescript');
          require('prismjs/components/prism-javascript');
          require('prismjs/components/prism-python');
          require('prismjs/components/prism-go');
          require('prismjs/components/prism-bash');
          require('prismjs/components/prism-json');

          marked.setOptions({
            highlight: function(code, lang) {
              if (Prism.languages[lang]) {
                return Prism.highlight(code, Prism.languages[lang], lang);
              }
              return code;
            }
          });

          const POSTS_DIR = 'posts';
          const OUTPUT_FILE = 'posts.json';
          
          function getAllPosts() {
            const posts = [];
            if (!fs.existsSync(POSTS_DIR)) {
              console.log('Posts directory not found. Creating...');
              fs.mkdirSync(POSTS_DIR);
              return posts;
            }
            
            const files = fs.readdirSync(POSTS_DIR);
            
            files.forEach(filename => {
              if (!filename.endsWith('.md') && !filename.endsWith('.mdx')) return;
              
              const filePath = path.join(POSTS_DIR, filename);
              const content = fs.readFileSync(filePath, 'utf-8');
              const { data, content: markdown } = matter(content);
              
              const readTime = readingTime(markdown);
              const html = marked(markdown);
              
              posts.push({
                title: data.title,
                date: data.date,
                tags: data.tags || [],
                path: `/posts/${filename}`,
                excerpt: data.excerpt || markdown.slice(0, 200) + '...',
                readingTime: readTime.text,
                content: html,
                lastModified: fs.statSync(filePath).mtime.toISOString()
              });
            });
            
            return posts.sort((a, b) => new Date(b.date) - new Date(a.date));
          }
          
          const posts = getAllPosts();
          fs.writeFileSync(OUTPUT_FILE, JSON.stringify(posts, null, 2));
          
          const tags = new Set();
          posts.forEach(post => post.tags.forEach(tag => tags.add(tag)));
          fs.writeFileSync('tags.json', JSON.stringify(Array.from(tags), null, 2));
          EOF
          
          node scripts/fetch-author.js
          node scripts/generate-index.js

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Update generated files" || echo "No changes to commit"
          git push
